!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).PenSDK={})}(this,(function(t){"use strict";class e{constructor(t,e,s=.5,i=3){this.tool=t,this.points=[e],this.pressures=[s],this.color="eraser"===t?"white":"black",this.width=i,this.baseSize=i,this.timestamp=Date.now()}addPoint(t,e=.5){this.points.push(t),this.pressures.push(e)}isValid(){return this.points.length>=2}getBoundingBox(){let t=1/0,e=1/0,s=-1/0,i=-1/0;for(const o of this.points)t=Math.min(t,o.x),e=Math.min(e,o.y),s=Math.max(s,o.x),i=Math.max(i,o.y);return{minX:t,minY:e,maxX:s,maxY:i}}clone(){const t=new e(this.tool,this.points[0],this.pressures[0],this.baseSize);return t.points=[...this.points],t.pressures=[...this.pressures],t.color=this.color,t.width=this.width,t.timestamp=this.timestamp,t}}class s{constructor(){this.currentTool="pen",this.defaultSizes={pen:3,chalk:5,eraser:20},this.customSizes={pen:3,chalk:5,eraser:20}}setTool(t){["pen","chalk","eraser"].includes(t)?this.currentTool=t:console.warn(`未知工具类型: ${t}`)}getToolSize(t){return t=t||this.currentTool,void 0!==this.customSizes?.[t]?this.customSizes[t]:this.defaultSizes[t]||3}setToolSize(t,e){e=e||this.currentTool;const s=parseFloat(t);return!isNaN(s)&&s>0&&(this.customSizes[e]=s,!0)}getCurrentTool(){return this.currentTool}}class i{constructor(t,e){this.canvas=t,this.getPressure=e,this.pointerIds=new Set,this.lastPointerType=null}bindEvents(t){const{onPointerDown:e,onPointerMove:s,onPointerUp:i}=t;this.canvas.addEventListener("pointerdown",(t=>{this.pointerIds.add(t.pointerId),this.lastPointerType=t.pointerType,e?.(t)})),this.canvas.addEventListener("pointermove",(t=>{this.pointerIds.has(t.pointerId)&&s?.(t)})),this.canvas.addEventListener("pointerup",(t=>{this.pointerIds.delete(t.pointerId),i?.(t)})),this.canvas.addEventListener("pointerleave",(t=>{this.pointerIds.delete(t.pointerId),i?.(t)})),this.canvas.style.touchAction="none"}getPointerPosition(t,e){const s=this.canvas.getBoundingClientRect();return{x:t-s.left,y:e-s.top}}}class o{constructor(){this.profileMap={surface:{pressureCurve:[.1,1.2],widthRange:[1,6],minPressure:.1},wacom:{pressureCurve:[.8,1],widthRange:[.8,5.5],minPressure:.05},apple:{pressureCurve:[1,1.1],widthRange:[1.2,6],minPressure:.01},default:{pressureCurve:[1,1],widthRange:[1,5],minPressure:.1}},this.currentProfile=this.profileMap.default}useProfile(t){this.currentProfile=this.profileMap[t]||this.profileMap.default}mapPressure(t){let e=.5;return"pen"===t.pointerType&&t.pressure>=0&&(e=t.pressure,e=1/(1+Math.exp(-6*(e-.3))),e=Math.max(.05,Math.min(.95,.05+.9*(e-.2)/.5))),e}}function r(t,e,s){return t*(1-s)+e*s}const n={length:t=>Math.sqrt(t.x*t.x+t.y*t.y)||.001,distance:(t,e)=>n.length({x:e.x-t.x,y:e.y-t.y}),normalize(t){const e=n.length(t);return{x:t.x/e,y:t.y/e}},fromPoints:(t,e)=>({x:e.x-t.x,y:e.y-t.y}),dot:(t,e)=>t.x*e.x+t.y*e.y,scale:(t,e)=>({x:t.x*e,y:t.y*e}),add:(t,e)=>({x:t.x+e.x,y:t.y+e.y}),lerp:(t,e,s)=>({x:r(t.x,e.x,s),y:r(t.y,e.y,s)})};function h(t,e,s,i={}){const o=e.x-t.x,r=e.y-t.y,n=s.x-e.x,h=s.y-e.y,a=Math.sqrt(o*o+r*r)||.001,c=Math.sqrt(n*n+h*h)||.001,l=o/a,d=r/a,p=n/c,u=h/c,m=l*p+d*u,x=(i.momentumFactor||.4)*(1+Math.max(0,1-m)),g=Math.min(1,Math.max(0,(1+m)/1.5)),y=l*(1-g)+p*g,f=d*(1-g)+u*g,v=Math.sqrt(y*y+f*f)||.001,P=y/v,S=f/v,w=(a+c)/2*x;return{cx:e.x+P*w,cy:e.y+S*w}}function a(t,e,s,i,o={}){const r=e.x-t.x,n=e.y-t.y,h=s.x-e.x,a=s.y-e.y,c=i.x-s.x,l=i.y-s.y,d=Math.sqrt(r*r+n*n)||.001,p=Math.sqrt(h*h+a*a)||.001,u=Math.sqrt(c*c+l*l)||.001,m=r/d,x=n/d,g=h/p,y=a/p,f=c/u,v=l/u,P=m*g+x*y,S=g*f+y*v,w=Math.max(0,1-P),_=Math.max(0,1-S),M=(d+p+u)/3,T=Math.min(1,M/(o.speedThreshold||25)),k=o.controlFactor||.35,b=p*k*(1+.75*w+.5*T),F=p*k*(1+.75*_+.5*T),C=Math.min(1,Math.max(0,(1+P)/1.5)),I=Math.min(1,Math.max(0,(1+S)/1.5)),z=m*(1-.7*C)+g*C*.3,E=x*(1-.7*C)+y*C*.3,L=g*(1-.3*I)+f*I*.7,D=y*(1-.3*I)+v*I*.7,R=Math.sqrt(z*z+E*E)||.001,q=Math.sqrt(L*L+D*D)||.001,j=z/R,B=E/R,O=L/q,U=D/q;return{cp1x:e.x+j*b,cp1y:e.y+B*b,cp2x:s.x-O*F,cp2y:s.y-U*F}}function c(t,e,s,i={}){const o=e.x-t.x,r=e.y-t.y,n=s.x-e.x,h=s.y-e.y,a=Math.sqrt(o*o+r*r)||.001,c=Math.sqrt(n*n+h*h)||.001,l=o/a,d=r/a,p=n/c,u=h/c,m=l*p+d*u,x=Math.max(0,1-m),g=Math.min(1,c/(i.speedThreshold||30)),y=i.momentumFactor||.4,f=!0===i.isLastSegment;let v=y*(1+x+.5*g);if(f){v*=Math.max(.2,Math.min(1,c/10)),m>.7&&(v*=.7)}const P=Math.min(1,Math.max(0,(1+m)/1.5)),S=l*(1-.5*P)+p*P*.5,w=d*(1-.5*P)+u*P*.5,_=Math.sqrt(S*S+w*w)||.001,M=S/_,T=w/_,k=c*v,b=e.x+M*k,F=e.y+T*k;let C=i.endFactor||.15;f&&(C*=.7);const I=C*(1-.5*x);return{cp1x:b,cp1y:F,cp2x:s.x-n*I,cp2y:s.y-h*I}}class l{constructor(t,e=1,s={}){this.ctx=t,this.dpr=e,this.minPointsForCurve=3,this.lowFPS=s.lowFPS??!1,this.smoothSteps=s.smoothSteps??4,this.angleThreshold=s.angleThreshold??.06,this.distanceThreshold=s.distanceThreshold??6,this.momentumFactor=s.momentumFactor??.5,this.curveFactor=s.curveFactor??.35}clearCanvas(t,e){this.ctx.clearRect(0,0,t/this.dpr,e/this.dpr)}renderStrokes(t){for(const e of t)this.renderStroke(e)}renderStroke(t){const e=t.points,s=t.pressures;if(!(e.length<2)){if(this.ctx.save(),this.ctx.lineCap="round",this.ctx.lineJoin="round",this.ctx.globalCompositeOperation="eraser"===t.tool?"destination-out":"source-over",this.ctx.strokeStyle=t.color,1===e.length)return this.ctx.beginPath(),this.ctx.arc(e[0].x,e[0].y,.5*t.baseSize,0,2*Math.PI),this.ctx.fill(),void this.ctx.restore();this.lowFPS&&e.length>10?this._renderOptimizedStroke(t,e,s):this._renderHighQualityStroke(t,e,s),this.ctx.restore()}}_renderOptimizedStroke(t,e,s){const i=this._sampleKeyPoints(e),o=this._resamplePressures(s,e,i);i.length<2||(this.ctx.beginPath(),this._renderSmoothedPath(i,o,t))}_sampleKeyPoints(t){if(t.length<=3)return[...t];const e=[t[0]];let s=0;for(let i=1;i<t.length-1;i++){const o=t[s],r=t[i],n=t[i+1],h=Math.sqrt(Math.pow(r.x-o.x,2)+Math.pow(r.y-o.y,2)),a={x:r.x-o.x,y:r.y-o.y},c={x:n.x-r.x,y:n.y-r.y},l=Math.sqrt(a.x*a.x+a.y*a.y)||.001,d=Math.sqrt(c.x*c.x+c.y*c.y)||.001,p={x:a.x/l,y:a.y/l},u={x:c.x/d,y:c.y/d},m=p.x*u.x+p.y*u.y,x=Math.acos(Math.max(-1,Math.min(1,m))),g=this.distanceThreshold*(.2+.8*Math.min(1,(1+m)/2));(x>this.angleThreshold||h>g||i-s>4)&&(e.push(r),s=i)}return s<t.length-1&&e.push(t[t.length-1]),e}_resamplePressures(t,e,s){if(e.length!==t.length)return s.map((()=>.5));const i=[];let o=0;const r=Math.min(20,Math.ceil(e.length/4));for(const n of s){let s=1/0,h=o;const a=Math.max(0,o-r),c=Math.min(e.length-1,o+r);for(let t=a;t<=c;t++){const i=Math.sqrt(Math.pow(n.x-e[t].x,2)+Math.pow(n.y-e[t].y,2));i<s&&(s=i,h=t)}if(h===a||h===c){const t=Math.max(0,a-r),i=Math.min(e.length-1,c+r),o=h===c?i:c;for(let i=h===a?t:a;i<=o;i++){if(i>=a&&i<=c)continue;const t=Math.sqrt(Math.pow(n.x-e[i].x,2)+Math.pow(n.y-e[i].y,2));t<s&&(s=t,h=i)}}o=h,i.push(t[h]||.5)}return i}_renderSmoothedPath(t,e,s){if(t.length<2)return;this.ctx.moveTo(t[0].x,t[0].y);const i=e[0]||.5;if(this.ctx.lineWidth=s.baseSize*(.5+i),2===t.length)return this.ctx.lineTo(t[1].x,t[1].y),void this.ctx.stroke();let o=0;for(;o<t.length-1;){const i=t.length-o,r=e[o]||.5;if(this.ctx.lineWidth=s.baseSize*(.5+r),2===i){this.ctx.lineTo(t[o+1].x,t[o+1].y);break}if(3===i){const e=t[o],s=t[o+1],i=t[o+2],r=h(e,s,i,{momentumFactor:this.momentumFactor});this.ctx.quadraticCurveTo(r.cx,r.cy,i.x,i.y);break}{const e=t[o],s=t[o+1],i=t[o+2],r=t[o+3],h=n.fromPoints(s,i),l=n.fromPoints(i,r),d=n.normalize(h),p=n.normalize(l),u=n.dot(d,p),m=o>=t.length-4;if(u<0){const{cp1x:t,cp1y:r,cp2x:n,cp2y:h}=c(e,s,i,{momentumFactor:this.momentumFactor,speedThreshold:20,endFactor:.2,isLastSegment:m});this.ctx.bezierCurveTo(t,r,n,h,i.x,i.y),o+=2}else if(0===o||o===t.length-4){const{cp1x:t,cp1y:r,cp2x:n,cp2y:h}=c(e,s,i,{momentumFactor:.4,speedThreshold:25,endFactor:.15,isLastSegment:m});this.ctx.bezierCurveTo(t,r,n,h,i.x,i.y),o+=2}else{const{cp1x:t,cp1y:n,cp2x:h,cp2y:c}=a(e,s,i,r,{controlFactor:this.curveFactor,speedThreshold:25});this.ctx.bezierCurveTo(t,n,h,c,i.x,i.y),o+=2}}}this.ctx.stroke()}_renderHighQualityStroke(t,e,s){if(e.length<=1)1===e.length&&(this.ctx.beginPath(),this.ctx.arc(e[0].x,e[0].y,.5*t.baseSize,0,2*Math.PI),this.ctx.fill());else{if(2===e.length){this.ctx.beginPath(),this.ctx.moveTo(e[0].x,e[0].y),this.ctx.lineTo(e[1].x,e[1].y);const i=t.baseSize*(.5+(s[0]||.5));return this.ctx.lineWidth=i,void this.ctx.stroke()}this.ctx.beginPath(),this._renderSmoothedPath(e,s,t)}}}class d{constructor(t,e={}){this.ctx=t,this.minPointsForCurve=3,this.smoothSteps=e.smoothSteps??4,this.lowFPS=e.lowFPS??!1}renderPreviewSegment(t){const e=t.points,s=t.pressures;e.length<this.minPointsForCurve||(this.ctx.save(),this.ctx.lineCap="round",this.ctx.lineJoin="round",this.ctx.globalCompositeOperation="eraser"===t.tool?"destination-out":"source-over",this.lowFPS?this._renderSimplifiedPreview(e,s,t):this._renderDetailedPreview(e,s,t),this.ctx.restore())}_renderSimplifiedPreview(t,e,s){if(t.length<3){const i=t[t.length-2],o=t[t.length-1],r=e[e.length-1]||.5;this.ctx.beginPath(),this.ctx.moveTo(i.x,i.y),this.ctx.lineTo(o.x,o.y);const n=s.baseSize*(.5+r);return this.ctx.strokeStyle=s.color,this.ctx.lineWidth=n,void this.ctx.stroke()}const i=Math.min(t.length,7),o=t.slice(-i),r=e.slice(-i);if(this.ctx.beginPath(),3===o.length){const t=o[0],e=o[1],s=o[2],i=h(t,e,s,{momentumFactor:.5});this.ctx.moveTo(e.x,e.y),this.ctx.quadraticCurveTo(i.cx,i.cy,s.x,s.y)}else if(o.length>=4){const t=o.length;o[t-4>=0?t-4:0];const e=o[t-3],s=o[t-2],i=o[t-1],r={x:s.x-e.x,y:s.y-e.y},n={x:i.x-s.x,y:i.y-s.y},h=Math.sqrt(r.x*r.x+r.y*r.y)||.001,a=Math.sqrt(n.x*n.x+n.y*n.y)||.001,l={x:r.x/h,y:r.y/h},d={x:n.x/a,y:n.y/a},p=l.x*d.x+l.y*d.y;if(this.ctx.moveTo(s.x,s.y),p<0){const{cp1x:t,cp1y:o,cp2x:r,cp2y:n}=c(e,s,i,{momentumFactor:.5,speedThreshold:20,endFactor:.2});this.ctx.bezierCurveTo(t,o,r,n,i.x,i.y)}else{const{cp1x:t,cp1y:o,cp2x:r,cp2y:n}=c(e,s,i,{momentumFactor:.4,speedThreshold:25,endFactor:.15});this.ctx.bezierCurveTo(t,o,r,n,i.x,i.y)}}const n=r[r.length-2]||.5,a=r[r.length-1]||.5,l=s.baseSize*(.5+(n+a)/2);this.ctx.strokeStyle=s.color,this.ctx.lineWidth=l,this.ctx.stroke()}_renderDetailedPreview(t,e,s){if(t.length<3){if(2===t.length){const i=t[t.length-2],o=t[t.length-1],r=e[e.length-2]||.5;this.ctx.beginPath(),this.ctx.moveTo(i.x,i.y),this.ctx.lineTo(o.x,o.y);const n=s.baseSize*(.5+r);this.ctx.strokeStyle=s.color,this.ctx.lineWidth=n,this.ctx.stroke()}return}const i=Math.min(t.length,5),o=t.slice(-i),r=e.slice(-i);this.ctx.beginPath(),this.ctx.moveTo(o[0].x,o[0].y);for(let t=1;t<o.length-1;t++){const e=t>1?o[t-2]:o[t-1],i=o[t-1],n=o[t];t<o.length-2?o[t+1]:o[t];const a=r[t-1]||.5,l=s.baseSize*(.5+a);if(this.ctx.lineWidth=l,1===t){const t=h(e,i,n,{momentumFactor:.4});this.ctx.quadraticCurveTo(t.cx,t.cy,n.x,n.y)}else{const{cp1x:t,cp1y:s,cp2x:o,cp2y:r}=c(e,i,n,{momentumFactor:.4,speedThreshold:25,endFactor:.15});this.ctx.bezierCurveTo(t,s,o,r,n.x,n.y)}}this.ctx.strokeStyle=s.color,this.ctx.stroke()}drawStartPoint(t,e="pen",s=1.5){this.ctx.save(),"eraser"===e&&(this.ctx.globalCompositeOperation="destination-out"),this.ctx.beginPath(),this.ctx.arc(t.x,t.y,s,0,2*Math.PI),this.ctx.fillStyle="eraser"===e?"rgba(0,0,0,1)":"black",this.ctx.fill(),this.ctx.restore()}}class p{constructor(t="DrawingBoard",e="info"){this.moduleName=t,this.levels={debug:0,info:1,warn:2,error:3},this.level=e,this.enabled=!0}setLevel(t){void 0!==this.levels[t]&&(this.level=t)}log(t,e,s){if(!this.enabled)return;if(this.levels[t]<this.levels[this.level])return;const i=`[${this.moduleName}][${t.toUpperCase()}]`;if(void 0!==s)try{console.log(i,e,"object"==typeof s?JSON.stringify(s):s)}catch{console.log(i,e,String(s))}else console.log(i,e)}debug(t,e){this.log("debug",t,e)}info(t,e){this.log("info",t,e)}warn(t,e){this.log("warn",t,e)}error(t,e){this.log("error",t,e)}setEnabled(t){this.enabled=t}}class u{constructor(t=null){this.logger=t,this.frameRates=[],this.renderTimes=[],this.droppedFrames=0,this._frameCount=0,this._lastFrameTime=performance.now(),this._active=!1,this._fpsCallbacks=[],this._lastFpsCheck=0,this._checkInterval=2e3,this._currentFps=60}onFpsChange(t){"function"==typeof t&&this._fpsCallbacks.push(t)}start(){if(this._active)return;this._active=!0;const t=()=>{const e=performance.now(),s=e-this._lastFrameTime;if(this._frameCount++,s>=1e3){const t=Math.round(1e3*this._frameCount/s);this.frameRates.push(t),this._currentFps=t,t<30&&(this.droppedFrames++,this.logger?.warn("低帧率检测",{fps:t})),e-this._lastFpsCheck>this._checkInterval&&(this._lastFpsCheck=e,this._notifyFpsCallbacks(t)),this._frameCount=0,this._lastFrameTime=e}this._active&&requestAnimationFrame(t)};requestAnimationFrame(t)}_notifyFpsCallbacks(t){for(const e of this._fpsCallbacks)try{e(t)}catch(t){this.logger?.error("FPS回调异常",t)}}getCurrentFps(){return this._currentFps}stop(){this._active=!1}measureRender(t){const e=performance.now();t();const s=performance.now()-e;this.renderTimes.push(s),s>33&&this.logger?.warn("渲染延迟过高",{duration:s})}exportMetrics(){return{frameRates:this.frameRates,renderTimes:this.renderTimes,droppedFrames:this.droppedFrames,avgFps:this.frameRates.length>0?this.frameRates.reduce(((t,e)=>t+e))/this.frameRates.length:0,avgRender:this.renderTimes.length>0?this.renderTimes.reduce(((t,e)=>t+e))/this.renderTimes.length:0}}}class m{constructor(t=null){this.logger=t,this.strokeCount=0,this.totalPoints=0,this.averagePoints=0,this.strokeDurations=[],this.directionChanges=0}track(t){const e=t.points.length,s=Date.now()-t.timestamp;let i=0;if(e>2)for(let s=2;s<e;s++){const e=t.points[s-2],o=t.points[s-1],r=t.points[s],n=o.x-e.x,h=o.y-e.y,a=r.x-o.x,c=r.y-o.y,l=n*a+h*c,d=Math.sqrt(n*n+h*h),p=Math.sqrt(a*a+c*c);if(d>0&&p>0){l/(d*p)<.866&&i++}}this.strokeCount++,this.totalPoints+=e,this.averagePoints=this.totalPoints/this.strokeCount,this.strokeDurations.push(s),this.directionChanges+=i,this.logger?.info("笔画完成",{points:e,duration:s+"ms",directionChanges:i,averagePressure:t.pressures.reduce(((t,e)=>t+e),0)/t.pressures.length})}exportStats(){return{strokeCount:this.strokeCount,totalPoints:this.totalPoints,averagePoints:this.averagePoints,totalDirectionChanges:this.directionChanges,averageDuration:this.strokeDurations.length>0?this.strokeDurations.reduce(((t,e)=>t+e))/this.strokeDurations.length:0}}}class x{constructor(t={}){this.factor=t.factor||.5,this.enabled=!1!==t.enabled,this.lastPoints=[],this.historySize=t.historySize||4,this.velocitySmoothing=t.velocitySmoothing||!1,this.jitterThreshold=t.jitterThreshold||2,this.accelerationThreshold=t.accelerationThreshold||.3,this._lastTime=0,this._velocities=[],this._directions=[],this._jitterCount=0}smooth(t){if(!this.enabled)return t;if(0===this.lastPoints.length)return this.lastPoints.push({...t,timestamp:Date.now()}),this._lastTime=Date.now(),t;const e=Date.now(),s=Math.max(1,e-this._lastTime);this._lastTime=e;const i=this.lastPoints[this.lastPoints.length-1];if(this.lastPoints.length>=2){const o=t.x-i.x,r=t.y-i.y,n=Math.sqrt(o*o+r*r),h=n/s;this._velocities.push(h),this._velocities.length>3&&this._velocities.shift();const a=this._velocities.reduce(((t,e)=>t+e),0)/this._velocities.length;if(n>.001){const t={x:o/n,y:r/n};this._directions.push(t),this._directions.length>3&&this._directions.shift()}let c=!1;const l=n<this.jitterThreshold;let d=0;if(this._directions.length>=2){for(let t=1;t<this._directions.length;t++){const e=this._directions[t-1],s=this._directions[t];d+=1-(e.x*s.x+e.y*s.y)}d/=this._directions.length-1}let p=0;if(this._velocities.length>=2){for(let t=1;t<this._velocities.length;t++){const e=this._velocities[t]/(this._velocities[t-1]||.001);p+=Math.abs(1-e)}p/=this._velocities.length-1}if(l&&(d>.8||p>this.accelerationThreshold)?(c=!0,this._jitterCount++):this._jitterCount=Math.max(0,this._jitterCount-.5),a>.5&&!c){const s=Math.max(.1,this.factor-.3*a),o={x:i.x*s+t.x*(1-s),y:i.y*s+t.y*(1-s),timestamp:e};return this.lastPoints.push(o),this.lastPoints.length>this.historySize&&this.lastPoints.shift(),o}if(c||this._jitterCount>1){const s=Math.min(.9,.6+.1*this._jitterCount),o=Math.min(.9,this.factor+.3*s),r={x:i.x*o+t.x*(1-o),y:i.y*o+t.y*(1-o),timestamp:e};return this.lastPoints.push(r),this.lastPoints.length>this.historySize&&this.lastPoints.shift(),r}}const o={x:i.x*this.factor+t.x*(1-this.factor),y:i.y*this.factor+t.y*(1-this.factor),timestamp:e};return this.lastPoints.push(o),this.lastPoints.length>this.historySize&&this.lastPoints.shift(),o}reset(){this.lastPoints=[],this._velocities=[],this._directions=[],this._jitterCount=0,this._lastTime=0}setOptions(t={}){void 0!==t.factor&&(this.factor=t.factor),void 0!==t.enabled&&(this.enabled=t.enabled),void 0!==t.historySize&&(this.historySize=t.historySize),void 0!==t.velocitySmoothing&&(this.velocitySmoothing=t.velocitySmoothing),void 0!==t.jitterThreshold&&(this.jitterThreshold=t.jitterThreshold),void 0!==t.accelerationThreshold&&(this.accelerationThreshold=t.accelerationThreshold)}}function g(){return window.devicePixelRatio||1}async function y(t=100){const e=performance.now();let s=0;for(;performance.now()-e<t;)s++;return{score:Math.min(1,s/50),iterations:s}}class f{constructor(t){this.canvas=document.getElementById(t),this.ctx=this.canvas.getContext("2d"),this.dpr=g(),this.canvas.width=this.canvas.clientWidth*this.dpr,this.canvas.height=this.canvas.clientHeight*this.dpr,this.ctx.scale(this.dpr,this.dpr),this.logger=new p("DrawingBoard","debug"),this.toolManager=new s,this.stylusAdapter=new o,this.renderer=new l(this.ctx,this.dpr),this.preview=new d(this.ctx),this.monitor=new u(this.logger),this.analytics=new m(this.logger),this.strokes=[],this.history=[],this.historyIndex=-1,this.currentStroke=null,this._isSimulatingLowFPS=!1,this._lastFrameTime=0,this._targetFPS=60,this._frameDuration=1e3/this._targetFPS,this.smoother=new x({factor:.3,historySize:3,enabled:!0}),this.inputHandler=new i(this.canvas,(t=>this.stylusAdapter.mapPressure(t))),this._bindEvents(),this.monitor.start(),this.canvasId=t,this.inputMode="pen",this._saveToHistory(),this._initRendererAndUI()}_bindEvents(){this.inputHandler.bindEvents({onPointerDown:this._onPointerDown.bind(this),onPointerMove:this._onPointerMove.bind(this),onPointerUp:this._onPointerUp.bind(this)})}_onPointerDown(t){const s=this.inputHandler.getPointerPosition(t.clientX,t.clientY),i=this.stylusAdapter.mapPressure(t);this.smoother.reset();const o=this.toolManager.getCurrentTool(),r=this.toolManager.getToolSize();this.currentStroke=new e(o,s,i,r),this.preview.drawStartPoint(s,o,r/2)}_onPointerMove(t){if(!this.currentStroke)return;if(this._isSimulatingLowFPS){const t=performance.now();if(t-this._lastFrameTime<this._frameDuration)return;this._lastFrameTime=t}const e=this.inputHandler.getPointerPosition(t.clientX,t.clientY);let s;if(this.lowPerformance){const t=this.smoother.smooth(e),i=this.smoother.smooth(t);s={x:(t.x+i.x)/2,y:(t.y+i.y)/2}}else s=this.smoother.smooth(e);const i=this.stylusAdapter.mapPressure(t);this.currentStroke.addPoint(s,i),this.preview.renderPreviewSegment(this.currentStroke)}_onPointerUp(){this.currentStroke?.isValid()&&(this.strokes.push(this.currentStroke),this._saveToHistory(),this.analytics.track(this.currentStroke),this.monitor.measureRender((()=>{this.renderer.clearCanvas(this.canvas.width,this.canvas.height),this.renderer.renderStrokes(this.strokes)}))),this.currentStroke=null}_saveToHistory(){const t=this.strokes.map((t=>t.clone()));this.historyIndex<this.history.length-1&&(this.history=this.history.slice(0,this.historyIndex+1)),this.history.push(t),this.historyIndex=this.history.length-1,this.logger?.debug("保存历史记录",{"历史索引":this.historyIndex,"历史记录数":this.history.length,"当前笔画数":this.strokes.length})}undo(){this.logger?.debug("准备撤销",{"历史索引":this.historyIndex,"历史记录数":this.history.length,"当前笔画数":this.strokes.length}),this.history.length>0&&this.historyIndex>0?(this.historyIndex--,this.strokes=this.history[this.historyIndex].map((t=>t.clone())),this.logger?.debug("撤销完成",{"回退到历史索引":this.historyIndex,"恢复后笔画数":this.strokes.length,"撤销前索引":this.historyIndex+1,"撤销前笔画数":this.history[this.historyIndex+1].length}),this.renderer.clearCanvas(this.canvas.width,this.canvas.height),this.renderer.renderStrokes(this.strokes)):this.logger?.debug("无法撤销 - 没有更早的历史记录",{"历史索引":this.historyIndex,"历史长度":this.history.length})}redo(){this.logger?.debug("准备重做",{"历史索引":this.historyIndex,"历史记录数":this.history.length}),this.historyIndex<this.history.length-1?(this.historyIndex++,this.strokes=this.history[this.historyIndex].map((t=>t.clone())),this.logger?.debug("重做完成",{"前进到历史索引":this.historyIndex,"恢复后笔画数":this.strokes.length}),this.renderer.clearCanvas(this.canvas.width,this.canvas.height),this.renderer.renderStrokes(this.strokes)):this.logger?.debug("无法重做 - 已是最新状态",{"历史索引":this.historyIndex,"历史长度":this.history.length})}clear(){this.strokes=[],this._saveToHistory(),this.renderer.clearCanvas(this.canvas.width,this.canvas.height)}setTool(t){this.toolManager.setTool(t)}setToolSize(t){this.toolManager.setToolSize(t)}getToolSize(){return this.toolManager.getToolSize()}toggleInputMode(){return this.inputMode="pen"===this.inputMode?"mouse":"pen",this.inputMode}exportLogs(){const t={strokes:this.strokes,metrics:this.monitor.exportMetrics(),behavior:this.analytics.exportStats()},e=new Blob([JSON.stringify(t,null,2)],{type:"application/json"}),s=URL.createObjectURL(e),i=document.createElement("a");return i.href=s,i.download=`drawing-log-${Date.now()}.json`,i.click(),URL.revokeObjectURL(s),t}exportDetailedAnalysis(){return{...this.monitor.exportMetrics(),...this.analytics.exportStats()}}simulateLowFPS(t){this._isSimulatingLowFPS=t,this._targetFPS=t?24:60,this._frameDuration=1e3/this._targetFPS,t?(this.lowPerformance=!0,this.logger?.info("已启用低帧率模式模拟",{targetFPS:this._targetFPS}),this.renderer.lowFPS=!0,this.preview.lowFPS=!0,this.preview.smoothSteps=2,this.renderer.smoothSteps=2,this.smoother.setOptions({factor:.7,historySize:6,enabled:!0,velocitySmoothing:!0,jitterThreshold:2.5})):(this.lowPerformance=!1,this.logger?.info("已禁用低帧率模式模拟"),this.renderer.lowFPS=!1,this.preview.lowFPS=!1,this.preview.smoothSteps=4,this.renderer.smoothSteps=4,this.smoother.setOptions({factor:.3,historySize:3,enabled:!0,velocitySmoothing:!1,jitterThreshold:2}))}async _initRendererAndUI(){const{score:t}=await y(),e=this.monitor?.exportMetrics?.().avgFps||60;this.lowPerformance=t<.6||e<30,this.logger?.info?.("性能评分",{score:t,fps:e});const s=e<30?2:4;this.renderer=new l(this.ctx,this.dpr,{lowFPS:this.lowPerformance,smoothSteps:s}),this.preview=new d(this.ctx,{lowFPS:this.lowPerformance,smoothSteps:s}),this.monitor.onFpsChange((t=>{t<28&&!this.lowPerformance?(this.lowPerformance=!0,this.logger?.info("自动切换到低帧率模式",{fps:t}),this.renderer.lowFPS=!0,this.preview.lowFPS=!0,this.preview.smoothSteps=2,this.renderer.smoothSteps=2):t>45&&this.lowPerformance&&(this.lowPerformance=!1,this.logger?.info("恢复正常渲染模式",{fps:t}),this.renderer.lowFPS=!1,this.preview.lowFPS=!1,this.preview.smoothSteps=4,this.renderer.smoothSteps=4)})),this.stylusProfile="default",this.setStylusProfile=t=>{this.stylusProfile=t,this.stylusAdapter?.useProfile?.(t)},this._debugEvent=t=>{console.log("PointerEvent:",{type:t.type,pointerType:t.pointerType,pressure:t.pressure,tiltX:t.tiltX,tiltY:t.tiltY,x:t.clientX,y:t.clientY})};const i=this._onPointerDown?.bind(this);this._onPointerDown=t=>{if(this._debugEvent(t),"pen"===this.inputMode&&"pen"!==t.pointerType)return;const e=t.pressure>0?t.pressure:.5;t._patchedPressure=e,i?.(t)},function({drawingBoard:t,container:e=document}){const s=["pen","eraser","chalk"],i=()=>{const e=t.getToolSize();l.value=e,d.textContent=e};s.forEach((s=>{const o=e.getElementById(`${s}-tool`);o&&o.addEventListener("click",(()=>{t.setTool(s),i()}))}));const o=e.getElementById("undo");o?.addEventListener("click",(()=>t.undo()));const r=e.getElementById("redo");r?.addEventListener("click",(()=>t.redo()));const n=e.getElementById("clear");n?.addEventListener("click",(()=>t.clear()));const h=e.getElementById("export-logs");h?.addEventListener("click",(()=>t.exportLogs()));const a=e.getElementById("input-mode-toggle"),c=e.getElementById("input-mode-text");a&&c&&a.addEventListener("click",(()=>{const e=t.toggleInputMode();c.textContent="pen"===e?"触控笔模式":"鼠标模式"}));const l=e.getElementById("size-slider"),d=e.getElementById("size-value");l&&d&&(l.addEventListener("input",(()=>{const e=parseInt(l.value);d.textContent=e,t.setToolSize(e)})),i(),s.forEach((t=>{const s=e.getElementById(`${t}-tool`);s?.addEventListener("click",i)})));const p=e.getElementById("export-analysis");p?.addEventListener("click",(()=>{const e=t.exportDetailedAnalysis?.();if(e){const t=JSON.stringify(e,null,2),s=new Blob([t],{type:"application/json"}),i=URL.createObjectURL(s),o=document.createElement("a");o.href=i,o.download=`drawing-analysis-${(new Date).toISOString().slice(0,19).replace(/:/g,"-")}.json`,o.click(),URL.revokeObjectURL(i)}}));const u=e.getElementById("simulate-lowfps");u?.addEventListener("change",(e=>{t.simulateLowFPS?t.simulateLowFPS(e.target.checked):console.warn("DrawingBoard 中未实现 simulateLowFPS 方法")}))}({drawingBoard:this}),this.logger?.info?.("初始化完成")}}window.drawingBoard=new f("drawing-board"),t.CanvasRenderer=l,t.DrawingBoard=f,t.PathSmoother=x,t.PreviewRenderer=d,t.Stroke=e,t.ToolManager=s,t.getDevicePixelRatio=g,t.measureDevicePerformance=y,Object.defineProperty(t,"__esModule",{value:!0})}));
